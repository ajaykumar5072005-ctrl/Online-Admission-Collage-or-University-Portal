<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Admission Form</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;}
.form-box{ max-width:520px; background:#fff; padding:20px; margin:40px auto; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,.1); }
input,select,button{ width:100%; box-sizing:border-box; padding:10px; margin-top:10px;}
.emi-option label{ margin-right:15px; cursor:pointer}
#emiCard{ background:#eef6ff; border:1px solid #004aad; padding:10px; margin-top:10px;}
button{ background:#004aad; color:#fff; border:none; font-size:16px; cursor:pointer;}
.err{ color:red; font-size:12px}
label{ display:block; margin-top:10px}
#paymentPage{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:none; justify-content:center; align-items:center; z-index:999;}
#paymentBox{ background:#fff; padding:20px; width:320px; border-radius:8px;}
.payBtn{ background:#0a8d48; margin-top:10px;}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<div class="form-box">
    <h2>Online Admission Form</h2>

    <input id="sname" placeholder="Student Name" oninput="this.value=this.value.replace(/[^A-Za-z ]/g,'')">
    <div id="err_sname" class="err"></div>
    <input id="father" placeholder="Father Name" oninput="this.value=this.value.replace(/[^A-Za-z ]/g,'')">
    <div id="err_father" class="err"></div>
    <input id="mother" placeholder="Mother Name" oninput="this.value=this.value.replace(/[^A-Za-z ]/g,'')">
    <div id="err_mother" class="err"></div>
    <input type="email" id="email" placeholder="Email ID">
    <div id="err_email" class="err"></div>
    <input type="password" id="password" placeholder="Create Password">
    <div id="err_password" class="err"></div>
    <input id="phone" placeholder="Phone Number">
    <div id="err_phone" class="err"></div>
    
    <select id="course" onchange="onCourseChange()">
        <option value="">Select Course</option>
        <option>A.N.M</option><option>B.tech</option><option>BBA</option>
        <option>BCA</option><option>B.com</option><option>BA.LLB</option>
        <option>BA</option><option>B.sc</option><option>B.sc Nursing</option>
        <option>B.sc Ag</option><option>B.Pharm</option><option>D.Pharm</option>
        <option>GNM</option><option>LLB</option><option>LAW</option>
        <option>MBA</option><option>MCA</option><option>M.com</option>
        <option>M.tech</option><option>Polytechnic</option>
    </select>

    <select id="branch" style="display:none"><option value="">Select Branch</option></select>
    <div id="err_branch" class="err"></div>

    <select id="studyType" style="display:none" onchange="loadYearSemester()">
        <option value="">Select Year / Semester</option>
        <option value="year">Year Wise</option>
        <option value="semester">Semester Wise</option>
    </select>
    <div id="err_studyType" class="err"></div>

    <select id="yearBox" style="display:none" onchange="updateDocuments()"></select>
    <div id="err_yearBox" class="err"></div>

    <select id="semesterBox" style="display:none" onchange="updateDocuments()"></select>
    <div id="err_semesterBox" class="err"></div>

    <div id="documents"></div>
    <div id="err_docs" class="err"></div>

    <div class="emi-option">
        <label><input type="radio" name="payment" value="full" checked onchange="updateFees()"> Full</label>
        <label><input type="radio" name="payment" value="emi" onchange="updateFees()"> EMI</label>
    </div>

    <div id="emiCountBox" style="display:none">
        <label><b>Select EMI Count (1 Year)</b></label>
        <select id="emiCount" onchange="calculateEMI()"></select>
    </div>

    <div id="feeDisplay"><b>Fee: ₹0</b></div>
    <div id="emiCard"></div>

    <input type="hidden" id="upiInput">

    <button onclick="submitForm()">Submit & Pay</button>
</div>

<div id="successPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000">
    <div style="background:#fff;max-width:350px;margin:120px auto;padding:20px;border-radius:8px;text-align:center">
        <h2 style="color:green">✔ Admission Successful</h2>
        <p>Aapka admission successfully ho gaya hai.</p>
        <button onclick="goToWebsite()">OK</button>
    </div>
</div>

<div id="paymentPage">
    <div id="paymentBox">
        <h3 id="payTitle">Online Payment</h3>
        <p id="amountText" style="font-weight:bold; color:green;"></p>
        
        <div id="pcPayment" style="display:none">
            <label>Enter Your UPI ID</label>
            <input id="upiPay" placeholder="example@upi">
            <button class="payBtn" onclick="showTransactionStep()">Proceed to Pay</button>
        </div>

        <div id="mobilePayment" style="display:none">
            <p>Select Payment App:</p>
            <button class="payBtn" onclick="openUPIApp('gpay')" style="background:#4285F4">Google Pay</button>
            <button class="payBtn" onclick="openUPIApp('phonepe')" style="background:#5f259f">PhonePe</button>
            <button class="payBtn" onclick="openUPIApp('paytm')" style="background:#00baf2">Paytm</button>
        </div>

        <div id="transactionStep" style="display:none; margin-top:15px; border-top:1px solid #ccc; padding-top:10px;">
            <label><b>Enter Transaction ID / UTR</b></label>
            <input id="utrID" placeholder="12-digit Number">
            <div id="payErr" class="err"></div>
            <button class="payBtn" style="background:#004aad" onclick="finalVerifyAndSubmit()">Final Submit Admission</button>
        </div>
        
        <button onclick="document.getElementById('paymentPage').style.display='none'" style="background:none; color:red; font-size:12px; border:none; margin-top:10px; cursor:pointer">Cancel</button>
    </div>
</div>

<script>
let paymentDone = false;
let currentPayableAmount = 0;

const courseFees={
"A.N.M":1,"B.tech":150000,"BBA":30000,"BCA":40000,"B.com":35000,
"BA.LLB":55000,"BA":15000,"B.sc":25000,"B.sc Nursing":150000,
"B.sc Ag":45000,"B.Pharm":85000,"D.Pharm":115000,"GNM":95000,
"LLB":25000,"LAW":37000,"MBA":60000,"MCA":55000,"M.com":35000,
"M.tech":200000,"Polytechnic":34000
};

const syllabusMap = { "A.N.M":"syllabus/anm.pdf","B.tech":"syllabus/btech.pdf","BBA":"syllabus/bba.pdf","BCA":"syllabus/bca.pdf","B.com":"syllabus/bcom.pdf","BA":"syllabus/ba.pdf","B.sc":"syllabus/bsc.pdf" };
const technicalBranches = { "B.tech":["CSE","ME","CE","EE","AI","DS"], "M.tech":["CSE","ME","CE","EE","AI"], "Polytechnic":["CSE","ME","CE","EE"] };

function onCourseChange(){
    studyType.style.display="block";
    updateFees();
    const branchBox = document.getElementById("branch");
    branchBox.innerHTML = "<option value=''>Select Branch</option>";
    branchBox.style.display = "none";
    if(technicalBranches[course.value]){
        branchBox.style.display="block";
        technicalBranches[course.value].forEach(b=>{branchBox.innerHTML += `<option value="${b}">${b}</option>`;});
    }
}

function loadYearSemester(){
    yearBox.style.display="none";semesterBox.style.display="none";yearBox.innerHTML="";semesterBox.innerHTML="";documents.innerHTML="";
    if(studyType.value==="year"){yearBox.style.display="block";yearBox.innerHTML="<option value=''>Select Year</option>";for(let i=1;i<=5;i++) yearBox.innerHTML+=`<option value="${i}">${i} Year</option>`;}
    if(studyType.value==="semester"){semesterBox.style.display="block";semesterBox.innerHTML="<option value=''>Select Semester</option>";for(let i=1;i<=10;i++) semesterBox.innerHTML+=`<option value="${i}">${i} Semester</option>`;}
}

function updateDocuments(){
    documents.innerHTML="";
    const year = yearBox.value; const sem = semesterBox.value;
    let docs=[{label:"Student Photo",type:"image/*"},{label:"Aadhaar Card",type:".pdf,.jpg,.png"}, {label:"10th Marksheet",type:".pdf,.jpg,.png"},{label:"12th Marksheet",type:".pdf,.jpg,.png"}];
    if(year){const y=parseInt(year);for(let i=1;i<y;i++){docs.push({label:`Year ${i} Marksheet`,type:".pdf,.jpg,.png"});}}
    if(sem){const s=parseInt(sem);for(let i=1;i<s;i++){docs.push({label:`Semester ${i} Marksheet`,type:".pdf,.jpg,.png"});}}
    docs.forEach(d=>{
        const div=document.createElement("div");
        div.innerHTML = `<label><b>${d.label}</b></label><input type="file" accept="${d.type}" data-required="true"><div class="err"></div>`;
        documents.appendChild(div);
    });
}

function updateFees(){
    const c=course.value;
    const p=document.querySelector('input[name="payment"]:checked').value;
    emiCard.innerHTML="";
    if(!c){ feeDisplay.innerText="Fee: ₹0"; emiCountBox.style.display="none"; return; }
    const fee=courseFees[c];
    if(p==="full"){feeDisplay.innerText=`Fee: ₹${fee}`; emiCountBox.style.display="none"; return;}
    emiCountBox.style.display="block"; emiCount.innerHTML="";
    if(fee>100000){[2,3,4].forEach(n=>emiCount.innerHTML+=`<option value="${n}">${n} EMI</option>`);}
    else{emiCount.innerHTML=`<option value="2">2 EMI</option>`;}
    calculateEMI();
}

function calculateEMI(){
    const fee = courseFees[course.value];const count = parseInt(emiCount.value);if(!count) return;
    const perEmi = Math.floor(fee / count);
    let html = `<b>EMI Breakdown (1 Year)</b><br>`; let remaining = fee;
    for(let i=1;i<=count;i++){let amt=(i===count)?remaining:perEmi;remaining-=amt;html+=`${i} EMI : ₹${amt}<br>`;}
    emiCard.innerHTML = html;
}

// 1. Initial Validation and Opening Payment Page
function submitForm(){
    document.querySelectorAll(".err").forEach(e=>e.innerText=""); 
    let valid=true;
    
    // Field Selectors
    const sname=document.getElementById("sname").value.trim();
    const email=document.getElementById("email").value.trim();
    const phone=document.getElementById("phone").value.trim();
    const courseVal=document.getElementById("course").value;
    const paymentMode = document.querySelector('input[name="payment"]:checked').value;

    // Simple Validations
    if(!sname){ document.getElementById("err_sname").innerText="Name required"; valid=false; }
    if(!email){ document.getElementById("err_email").innerText="Email required"; valid=false; }
    if(!phone || phone.length < 10){ document.getElementById("err_phone").innerText="Valid Phone required"; valid=false; }
    if(!courseVal){ document.getElementById("err_course").innerText="Select Course"; valid=false; }
    
    let docInputs=document.querySelectorAll("#documents input[type=file]");
    docInputs.forEach(input=>{if(!input.files.length){ input.nextElementSibling.innerText="Upload required"; valid=false; }});

    if(!valid) return;

    // Calculate Amount
    const totalFee = courseFees[courseVal];
    currentPayableAmount = (paymentMode === "full") ? totalFee : Math.ceil(totalFee / parseInt(document.getElementById("emiCount").value));

    // Open Payment Modal
    document.getElementById("amountText").innerText = "Payable Amount: ₹" + currentPayableAmount;
    document.getElementById("paymentPage").style.display = "flex";

    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.getElementById("mobilePayment").style.display = "block";
        document.getElementById("pcPayment").style.display = "none";
    } else {
        document.getElementById("pcPayment").style.display = "block";
        document.getElementById("mobilePayment").style.display = "none";
    }
}

function openUPIApp(app) {
    const upiId = "7055410597@fam"; 
    const upiUrl = `upi://pay?pa=${upiId}&pn=FS%20University&am=${currentPayableAmount}&cu=INR&tn=Admission%20Fee`;
    window.location.href = upiUrl;
    setTimeout(showTransactionStep, 4000);
}

function showTransactionStep() {
    document.getElementById("pcPayment").style.display = "none";
    document.getElementById("mobilePayment").style.display = "none";
    document.getElementById("transactionStep").style.display = "block";
}

// 2. Final Verification after entering Transaction ID
function finalVerifyAndSubmit() {
    const utr = document.getElementById("utrID").value.trim();
    if(utr.length < 8) {
        document.getElementById("payErr").innerText = "Enter valid Transaction ID";
        return;
    }
    document.getElementById("upiInput").value = utr;
    paymentDone = true;
    document.getElementById("paymentPage").style.display = "none";
    processDataAndSave();
}

// 3. Save Data and Generate PDF
function processDataAndSave() {
    let students = JSON.parse(localStorage.getItem("students")) || [];
    const sname=document.getElementById("sname").value;
    const email=document.getElementById("email").value;
    const courseVal=document.getElementById("course").value;
    const paymentMode = document.querySelector('input[name="payment"]:checked').value;
    
    let admissionNo = "FSU" + Date.now();
    
    let newStudent = {
        admissionNo: admissionNo,
        name: sname,
        email: email,
        course: courseVal,
        paymentMode: paymentMode,
        utr: document.getElementById("upiInput").value,
        date: new Date().toLocaleDateString()
    };

    students.push(newStudent);
    localStorage.setItem("students", JSON.stringify(students));
    localStorage.setItem("currentStudent", JSON.stringify(newStudent));

    generatePDF();
    document.getElementById("successPopup").style.display = "block";
}

function generatePDF(){
    const student = JSON.parse(localStorage.getItem("currentStudent"));
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    pdf.setFillColor(0,74,173); pdf.rect(0,0,210,30,"F");
    pdf.setTextColor(255,255,255); pdf.setFontSize(18);
    pdf.text("FS UNIVERSITY - RECEIPT",105,20,{align:"center"});

    pdf.setTextColor(0,0,0); pdf.setFontSize(12);
    pdf.text(`Admission No: ${student.admissionNo}`, 10, 40);
    pdf.text(`Student Name: ${student.name}`, 10, 50);
    pdf.text(`Course: ${student.course}`, 10, 60);
    pdf.text(`Paid Amount: ₹${currentPayableAmount}`, 10, 70);
    pdf.text(`Transaction ID: ${student.utr}`, 10, 80);
    pdf.text(`Status: PAID`, 10, 90);

    pdf.save(`Receipt_${student.name}.pdf`);
}

function goToWebsite(){ window.location.href="profile.html"; }

document.addEventListener("DOMContentLoaded", function() {
    const old = JSON.parse(localStorage.getItem("reApplyStudent"));
    if(old) {
        document.getElementById("sname").value = old.name;
        document.getElementById("email").value = old.email;
        // lock fields if necessary
    }
});
</script>
</body>
</html>